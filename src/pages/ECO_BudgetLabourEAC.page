<apex:page standardController="BudgetHeader__c" extensions="ECO_BudgetLabourEACController" sidebar="false" showHeader="false">
   <apex:composition template="ECO_BudgetFrame">
        <apex:define name="budgetScreen"> 
    <apex:includeScript value="{!$Resource.ECO_jQuery_1_11_2_min_js}"/>
    <script type="text/javascript">
    	$b = jQuery.noConflict();
		
    function forecastChange(line) {
        var row = $b(line).closest('tr');
        var actual = parseFloat(row.find('[id$="currentForecast"]').text());
        var forecast = parseFloat(row.find('[id$="forecast"]').val());
        actual = actual ? actual : 0.00;
        forecast = forecast ? forecast : 0.00;
        
        row.find('[id$="etc"]').val(forecast-actual);
    }
    
    function etcChange(line) {
        var row = $b(line).closest('tr');
        var actual = parseFloat(row.find('[id$="currentForecast"]').text());
        var etc = parseFloat(row.find('[id$="etc"]').val());
        actual = actual ? actual : 0.00;
        etc = etc ? etc : 0.00;
        
        row.find('[id$="forecast"]').val(etc+actual);
    }
    </script>
    
    <style>
        .laborDetail>td, .laborDetail>th, td.resourceColumn th, td.resourceColumn td {
            border-top: 1px solid black;
            border-left: 1px solid black;
            border-right: 1px solid black;
        }
        .laborDetail>td.lastCell {
            border-bottom: 1px solid black;
        }
        
        .taskDetailHeader>td{
            border-left: 1px solid black;
            border-top: 1px solid black;
            border-bottom: 1px solid black;
            padding:3px;
            height: 20px;
        }
        
        .laborDetail input, .taskDetail input{
        	width:80%;
        }
        
        .taskDetail>td{
            border-left: 1px solid black;
            border-top: 1px solid black;
            padding:3px;
            height: 20px;
        }
        
        .taskDetail>td.lastCell{
            border-right: 1px solid black;
        }
        
        table.rowHeader>th, table.rowHeader>td {
            border-top: 1px solid transparent;
            border-left: 1px solid transparent;
            border-right: 1px solid transparent;
       }
        table.rowHeader>td.lastCell {
            border-bottom: 1px solid transparent;
        }
        table.laborDetail {
            width: 100%;
        }
        table.rowHeader>td, table.laborDetail>td, table.rowHeader>th, table.laborDetail>th {
            padding:3px;
            height: 20px;
        }
        .tableInputs {
            padding: 0;
            height: 20px;
        }
        
        .blueHeading {
            background-color:#00B0F0;
            color:#fff;
            font-weight: bold;
        }
        
        .lightBlueHeading {
            background-color: #C5D9F1;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .grayHeading {
            background-color: #BFBFBF;
            font-weight: bold;
        }
    </style>
    <apex:sectionHeader title="Labour Details"/>  
<!-- TODO
    <c:ECO_ModalDialog width="600" padding="20px 20px 20px 20px" name="modalDialog0">
        <c:ECO_AddResource budgetHeader="{!BudgetHeader__c.id}" />
    </c:ECO_ModalDialog>    
-->
    <apex:form >
        <apex:pageMessages />
    <table style="width:100%" cellpadding="0" cellspacing="0">
        <tr>
            <td></td>
            <td>
                <table class="rowHeader" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr><th>
                            <apex:commandButton value="Save" action="{!saveEAC}"/>
                            <apex:commandButton value="Previous" action="{!prevPage}" rendered="{!brSsc.hasPrevious}" immediate="false"/>
                            <apex:commandButton value="Next" action="{!nextPage}" rendered="{!brSsc.hasNext}" immediate="false"/>
                        <!-- TODO   
<apex:commandButton value="Add Resource" onclick="openModal('modalDialog0');return false;"/> -->
                        </th></tr>
                        <tr><th>&nbsp;</th></tr>
                        <tr><th>&nbsp;</th></tr>
                        <tr><th>&nbsp;</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Total Cost Rate  (FBLR)</td></tr>
                        <tr><td>Raw</td></tr>
                        <tr><td>Fringe</td></tr>
                        <tr><td>O/H</td></tr>
                    
                        <tr><td style="height: 20px;">&nbsp;</td></tr> <!-- Validate if we can replace with css padding -->
                    
                        <tr><td>Revenue Rate</td></tr>
                        <tr><td>Margin Type</td></tr>
                        <tr><td class="lastCell">Bill Rate or % Markup</td></tr>
                    </tbody>
                </table>
            </td>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour">
            <td>
                <table class="laborDetail" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr><th class="blueHeading" colspan="5">{!budgetLabour.resourceType}</th></tr>
                        <tr><th class="blueHeading" colspan="5">
                            <!-- TODO
                            <apex:commandLink title="Clone" action="{!cloneResource}">
                                <apex:param name="budgetLabourId" value="{!budgetLabour.oBudgetResource.Id}"/>
                                <apex:image value="{!URLFOR($Resource.ECO_CustomGraphicAssets, 'clone.png')}" width="12" style="margin-right: 8px;" />
                            </apex:commandLink>
                            <apex:commandLink title="Delete" action="{!removeEntireColumn}" >
                                <apex:param name="budgetLabourId" value="{!budgetLabour.oBudgetResource.Id}"/>
                                <apex:image value="{!URLFOR($Resource.ECO_CustomGraphicAssets, 'trash.png')}" width="12" />
                            </apex:commandLink>
-->
                        </th></tr>
                        <tr><td class="lightBlueHeading" colspan="5">{!budgetLabour.columnHeader}&nbsp;</td></tr>
                        <tr><td colspan="5">{!budgetLabour.jobName}&nbsp;</td></tr>
                    </thead>
                    <tbody class="cost">
                        <tr><td class="lightBlueHeading bold">{!budgetLabour.costRate}</td></tr>
                        <tr><td class="tableInputs"><apex:inputText value="{!budgetLabour.raw}"/></td></tr>
                        <tr><td class="tableInputs"><apex:inputText value="{!budgetLabour.fringe}" /></td></tr>
                        <tr><td class="tableInputs"><apex:inputText value="{!budgetLabour.overhead}"/></td></tr>
                    </tbody>
                    <tr><td style="height: 20px;">&nbsp;</td></tr> <!-- Validate if we can replace with css padding -->
                    <tbody class="revenue">
                        <tr><td class="lightBlueHeading bold"><apex:outputText value="{!budgetLabour.revenueRate}"/></td></tr>
                        <tr>
                            <td>
                                <apex:selectList value="{!budgetLabour.marginType}" size="1">
                                    <apex:selectOption itemValue="Amount" itemLabel="Amount" />
                                    <apex:selectOption itemValue="Percent" itemLabel="Percent" />
                                </apex:selectList>
                            </td>
                        </tr>
                        <tr><td class="lastCell"><apex:inputText value="{!budgetLabour.billRateOrMarkup}"/></td></tr>
                    </tbody>
                </table>
            </td>
        </apex:repeat>
        </tr>
        <tr><td style="height: 20px;">&nbsp;</td></tr>
        <tr class="taskDetailHeader">
            <td class="grayHeading">Task Number</td>
            <td class="grayHeading">Task Name</td>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour">
          <td class="lightBlueHeading bold">
            <table width="100%">
                <tr> 
                    <td class="lightBlueHeading bold" width="20%">Actual Hrs</td>
                    <td class="lightBlueHeading bold" width="20%">Current Approved Hrs</td>
                    <td class="lightBlueHeading bold" width="20%">Current Forecast Hrs</td>
                    <td class="lightBlueHeading bold" width="20%">Estimate to Complete</td>
                    <td class="lightBlueHeading bold" width="20%">Revised Forecast Hrs</td>
                </tr>
            </table>
        </td>
        </apex:repeat>
            <td class="blueHeading">Actual Hrs</td>
            <td class="blueHeading">Current Approved Hrs</td>
            <td class="blueHeading">Current Forecast Hrs</td>
            <td class="blueHeading">Estimate to Complete</td>
            <td class="blueHeading">Revised Forecast Hrs</td>
            
            <td class="blueHeading">Actual Cost</td>
            <td class="blueHeading">Current Approved Cost</td>
            <td class="blueHeading">Current Forecast Cost</td>
            <td class="blueHeading">Estimate to Complete</td>
            <td class="blueHeading">Revised Forecast Cost</td>
            
            <td class="blueHeading">Actual Revenue</td>
            <td class="blueHeading">Current Approved Revenue</td>
            <td class="blueHeading">Current Forecast Revenue</td>
            <td class="blueHeading">Estimate to Complete</td>
            <td class="blueHeading">Revised Forecast Revenue</td>
        </tr>
        <tr><td style="height: 5px;">&nbsp;</td></tr>
     
        <tr class="taskDetail">
            <td class="bold">Project Total</td>
            <td></td>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour"> <!--list<DTO_BudgetLaborDetail>-->
            <td>
                <table width="100%">
                    <tr> 
                    <apex:variable value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask[budgetLabour.oBudgetResource.Id + 'Total']}" var="totalByResource"/>
                        <td width="20%">{!totalByResource.EACActualQuantity}</td>
                        <td width="20%">{!totalByResource.EACApprovedQuantity}</td> 
                        <td width="20%">{!totalByResource.EACForecastQuantity}</td>
                        <td width="20%">{!totalByResource.Quantity}</td>
                        <td width="20%">{!IF(ISNULL(totalByResource.EACActualQuantity), 0, totalByResource.EACActualQuantity) + 
                        IF(ISNULL(totalByResource.Quantity), 0, totalByResource.Quantity)}</td>
                        
                    </tr>
                </table>
            </td>
        </apex:repeat>
            
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACActualQuantity}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACApprovedQuantity}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACForecastQuantity}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.Quantity}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.Quantity + budgetLabourWrapper.grandTotals.EACActualQuantity}</td>

            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACActualCost}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACCurrentApprovedCost}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACCurrentForecastCost}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACEstimateToComplete}</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACEstimateToComplete + budgetLabourWrapper.grandTotals.EACActualCost}</td>

            <td class="blueHeading">&nbsp;</td>
            <td class="blueHeading">&nbsp;</td>
            <td class="blueHeading">{!budgetLabourWrapper.grandTotals.EACForecastRevenue}</td>
            <td class="blueHeading">&nbsp;</td>
            <td class="blueHeading">&nbsp;</td>
            
        </tr>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetTasks}" var="budgetTask"> <!--list<DTO_BudgetTask>-->
            <apex:variable value="{!IF(budgetTask.children.size > 0, true, false)}" var="hasChildTasks" />
            <tr class="taskDetail">
                <td>
                    <div style="margin-left: {!budgetTask.indentLevel * 13}px;">
                        {!budgetTask.taskNumber} (level {!budgetTask.indentLevel})
                    </div>
                </td>
                <td>
                    <div style="margin-left: {!budgetTask.indentLevel * 13}px;">
                        {!budgetTask.taskName}
                    </div>
                </td>
            <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour"> <!--list<DTO_BudgetLaborDetail>-->
                <td>
                    <table width="100%">
                        <tr>
                        <span>
                            <td class="lightBlueHeading" width="20%">
                                <apex:outputText value="{!budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].EACActualQuantity__c }" rendered="{! !hasChildTasks}" id="actual" />
                                <apex:outputText value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id].EACActualQuantity}" rendered="{!hasChildTasks}"/>
                            </td>
                            <td class="lightBlueHeading" width="20%">
                                <apex:outputText value="{!budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].EACApprovedQuantity__c }" rendered="{! !hasChildTasks}" />
                                <apex:outputText value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id].EACApprovedQuantity}" rendered="{!hasChildTasks}"/>
                            </td>
                            <td class="lightBlueHeading" width="20%">
                                <apex:outputText value="{!budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].EACForecastQuantity__c }" rendered="{!budgetTask.children.size == 0}" id="currentForecast"/>
                                <apex:outputText value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id].EACForecastQuantity}" rendered="{!hasChildTasks}"/>
                            </td>      
                            <td  width="20%" class="{!IF(budgetTask.children.size == 0,'','lightBlueHeading bold')}">
                                <apex:inputField value="{!budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].Quantity__c}" id="etc" rendered="{! !hasChildTasks}" OnKeyUp="etcChange(this);" /> <!--   -->
                                <!-- <apex:inputText value="{!budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].Quantity__c}" rendered="{!budgetTask.children.size == 0}" /> -->
                                <apex:outputText value="{!budgetLabourWrapper.mapTotalByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id]}" rendered="{! hasChildTasks}"/>
                            </td>
                            <td width="20%" class="{!IF(budgetTask.children.size == 0,'','lightBlueHeading bold')}">
                                <apex:outputPanel rendered="{! !hasChildTasks}" > 
                                    <input type="text" 
                                           value="{!IF(budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].Quantity__c == null, 0, budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].Quantity__c) + 
                                                  IF(budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].EACForecastQuantity__c == null, 0, budgetLabour.mAssignmentMap[budgetTask.obudgetTask.Id].EACForecastQuantity__c)
                                                  	}" 
                                           OnKeyUp="forecastChange(this);" id="{!budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id}forecast"/>
                                </apex:outputPanel>
                                <!--<apex:inputText value="{!budgetLabour.mapRevisedForecast[budgetTask.obudgetTask.Id]}" id="forecast"
                                                rendered="{!budgetTask.children.size == 0}" OnKeyUp="forecastChange(this);"/>-->
                                <apex:outputText value="{!budgetLabourWrapper.mapTotalByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id] + 
                                                        budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask['' + budgetLabour.oBudgetResource.Id + budgetTask.oBudgetTask.Id].EACActualQuantity}"
                                                 rendered="{!hasChildTasks}"/>
                            </td>
                            </span>
                        </tr>

                    </table>

                </td>
            </apex:repeat>
                <td class="blueHeading">{!budgetTask.totalEACActualQuantity}</td>
                <td class="blueHeading">{!budgetTask.totalEACApprovedQuantity}</td>
                <td class="blueHeading">{!budgetTask.totalEACForecastQuantity}</td>
                <td class="blueHeading">{!budgetTask.totalLaborHours}</td>
                <td class="blueHeading">{!IF(budgetTask.totalEACActualQuantity==null,0,budgetTask.totalEACActualQuantity) +
                 IF(budgetTask.totalLaborHours==null,0,budgetTask.totalLaborHours)}
                 </td>

                <td class="blueHeading">{!budgetTask.totalEACActualCost}</td>
                <td class="blueHeading">{!budgetTask.totalEACApprovedTotalCost}</td>
                <td class="blueHeading">{!budgetTask.totalEACForecastTotalCost}</td>
                <td class="blueHeading">{!budgetTask.totalCost}</td>
                <td class="blueHeading">{!IF(budgetTask.totalEACActualCost==null,0,budgetTask.totalEACActualCost) +
                 IF(budgetTask.totalCost==null,0,budgetTask.totalCost)}
                 </td>

                <td class="blueHeading">&nbsp;<!-- TODO: {!budgetTask.totalEACActualRevenue}--></td>
                <td class="blueHeading">&nbsp;<!-- TODO: {!budgetTask.totalEACApprovedQuantity}--></td>
                <td class="blueHeading">{!budgetTask.totalEACForecastRevenue}</td>
                <td class="blueHeading">{!budgetTask.totalRevenue}</td>
                <td class="blueHeading">{!0 +
                 IF(budgetTask.totalRevenue==null,0,budgetTask.totalRevenue)}
                 </td> 
               <!--  
                <td class="blueHeading">{!budgetTask.totalLaborHours}</td>

                <td class="blueHeading">
                    <apex:outputText value="{0, number, ###,###,###,##0.00}">
                        <apex:param value="{!budgetTask.totalLabourCost}" />
                    </apex:outputText>
                </td>
                <td class="blueHeading">
                    <apex:outputText value="{0, number, ###,###,###,##0.00}">
                        <apex:param value="{!budgetTask.totalLabourRevenue}" />
                    </apex:outputText>
                </td>
                -->
            </tr>
        </apex:repeat>
        <tr class="taskDetail">
            <td></td>
            <td>Total Cost by Person</td>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour"> <!--list<DTO_BudgetLaborDetail>-->
            <td class="lightBlueHeading">
                <table width="100%">
                    <tr> 
                    <apex:variable value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask[budgetLabour.oBudgetResource.Id + 'Total']}" var="totalByResource"/>
                        <td width="20%">{!totalByResource.EACActualCost}</td>
                        <td width="20%">{!totalByResource.EACCurrentApprovedCost}</td> 
                        <td width="20%">{!totalByResource.EACCurrentForecastCost}</td>
                        <td width="20%">{!totalByResource.Quantity}</td>
                        <td width="20%">{!IF(ISNULL(totalByResource.EACActualCost), 0, totalByResource.EACActualCost) + 
                        IF(ISNULL(totalByResource.Quantity), 0, totalByResource.Quantity)}</td>
                        
                    </tr>
                </table>
            </td>
        </apex:repeat>
        </tr>
        <tr class="taskDetailHeader">
            <td></td>
            <td>Total Revenue by Person</td>
        <apex:repeat value="{!budgetLabourWrapper.dtoBudgetLabourDetails}" var="budgetLabour"> <!--list<DTO_BudgetLaborDetail>-->
            <td class="lightBlueHeading">
                <table width="100%">
                    <tr> 
                    <apex:variable value="{!budgetLabourWrapper.mapEACTotalsByLaborDetailAndTask[budgetLabour.oBudgetResource.Id + 'Total']}" var="totalByResource"/>
                        <td width="20%">{!totalByResource.EACActualCost}</td>
                        <td width="20%">{!totalByResource.EACCurrentApprovedCost}</td> 
                        <td width="20%">{!totalByResource.EACCurrentForecastCost}</td>
                        <td width="20%">{!totalByResource.Quantity}</td>
                        <td width="20%">{!IF(ISNULL(totalByResource.EACActualCost), 0, totalByResource.EACActualCost) + 
                        IF(ISNULL(totalByResource.Quantity), 0, totalByResource.Quantity)}</td>
                        
                    </tr>
                </table>
            </td>
        </apex:repeat>
        </tr>
    </table>
    </apex:form>
            
       </apex:define>
    </apex:composition> 
</apex:page>